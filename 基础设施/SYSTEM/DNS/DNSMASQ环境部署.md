# DNSMASQ环境部署

### 1.目的

局域网测试环境主机间域名管理，主要为虚拟机模拟环境测试提供便利的DNS服务。

### 2.环境

**操作系统：**Ubuntu 16.04 Server（虚拟机）
**IP地址：**192.168.146.250
**核心配置文件：**

- /etc/resolv.conf    指定系统DNS服务器
- /etc/dnsmasq.conf    DNSMASQ主配置文件
- /etc/dnsmasq.resolv.conf    调整后系统DNS配置文件
- /etc/dnsmasq.hosts    DNS解析文件

### 3.部署步骤

step1.

```bash
sudo apt-get install dnsmasq
```

step2.修改/etc/dnsmaq.conf

```bash
resolv-file=/etc/dnsmasq.resolv.conf    #将/etc/resolv.conf文件指向/etc/dnsmasq.resolv.conf     ????此处有疑问
listen-address=127.0.0.1,192.168.146.250    #由于DNS服务需要提供给局域网内其他host使用，因此除本地回环外还需要静态IP
addn-hosts=/etc/dnsmasq.hosts    #默认使用/etc/hosts解析，此处定义解析文件
```



step3.修改 /etc/resolv.conf，该文件为链接文件，如果需要彻底修改需要修改如下路径文件/etc/resolvconf/resolv.conf.d/head

```bash
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 127.0.0.1
nameserver 192.168.146.2    #step3的疑问：理论上该位置不需要设定，仅需还回地址，解析任务将自动被转到/etc/dnsmasq.resolv.conf指定的dns，当然任然是本机

```


step4.修改/etc/dnsmasq.resolv.conf，**之所以要配置该文件是为了解决resolv文件只能指定3个nameserver的限制**
```bash
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 192.168.146.2
nameserver 8.8.8.8
```
step5.修改地址解析文件 /etc/dnsmasq.hosts，使用一般hosts文件格式

以上简单部署完成，客户端仅需添加DNS服务地址即可

### 4.其他步骤

**设置主机名：**
```bash
sudo hostnamectl set-hostname <HOSTNAME>
```
注意，修改地址解析文件后需要重启服务。